<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>كوزو كتب</title>
<link rel="icon" href="https://cdn-icons-png.flaticon.com/128/18600/18600824.png" type="image/svg+xml" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.4/dist/xlsx.full.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f0f0f0;
    margin: 0; padding: 0;
    direction: rtl;
    min-height: 100vh;
    display: flex; justify-content: center; align-items: flex-start;
  }
  .container {
    max-width: 800px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 20px;
    margin: 20px;
    text-align: right;
    width: 100%;
  }
  h1 {
    font-size: 28px; margin-bottom: 20px; color: #333; text-align: center;
  }
  form {
    display: flex; justify-content: center; margin-bottom: 20px;
  }
  #searchInput {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
    text-align: right;
  }
  button {
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    margin-right: 10px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #45a049;
  }
  #message {
    color: red;
    text-align: center;
    margin-top: 15px;
    font-size: 18px;
  }
  #result {
    margin-top: 20px;
    text-align: right;
    font-size: 18px;
  }
  #result a {
    color: #1e88e5;
    text-decoration: none;
    font-weight: bold;
  }
  #result a:hover {
    text-decoration: underline;
  }
  #backToSearch {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #1976d2;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  #backToSearch:hover {
    background-color: #115293;
  }
</style>
</head>
<body>
  <div class="container">
    <h1 id="pageTitle">كوزو كتب</h1>

    <form id="searchForm">
      <input type="text" id="searchInput" name="query" placeholder="أدخل نص البحث" autocomplete="off" />
      <button type="submit">بحث</button>
    </form>

    <div id="message"></div>
    <div id="result"></div>
  </div>

<script>
  let workbook;

  function loadExcel() {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', './kutub.xlsx', true);
      xhr.responseType = 'arraybuffer';
      xhr.onload = function() {
        if (xhr.status === 200) {
          try {
            const data = new Uint8Array(xhr.response);
            workbook = XLSX.read(data, { type: 'array' });
            resolve(workbook);
          } catch (e) {
            reject('خطأ في معالجة ملف Excel');
          }
        } else {
          reject('تعذر تحميل ملف Excel');
        }
      };
      xhr.onerror = () => reject('خطأ في الاتصال بخادم Excel');
      xhr.send();
    });
  }

  // ابحث عن أول كتاب مطابق وأرجع كائن يحتوي على التفاصيل
  async function findBookDetails(searchText) {
    if (!workbook) return null;

    for (const sheetName of workbook.SheetNames) {
      const sheet = workbook.Sheets[sheetName];
      const range = XLSX.utils.decode_range(sheet['!ref']);

      for (let R = range.s.r; R <= range.e.r; ++R) {
        for (let C = range.s.c; C <= range.e.c; ++C) {
          const cellAddress = { c: C, r: R };
          const cellRef = XLSX.utils.encode_cell(cellAddress);
          const cell = sheet[cellRef];

          if (cell && cell.v && cell.v.toString().includes(searchText)) {
            // لنفترض هنا أن:
            // عنوان الكتاب في الخلية الحالية (cell.v)
            // الرابط في الخلية التالية في نفس الصف (C+1)
            // يمكنك تعديل هذا حسب ملف Excel لديك

            const title = cell.v.toString();
            const linkCellRef = XLSX.utils.encode_cell({c: C + 1, r: R});
            const linkCell = sheet[linkCellRef];
            const link = linkCell && linkCell.v ? linkCell.v.toString() : 'لا يوجد رابط';

            return { title, link };
          }
        }
      }
    }
    return null;
  }

  function showBookDetails(book) {
    document.getElementById('message').textContent = '';
    document.getElementById('searchForm').style.display = 'none';
    document.getElementById('pageTitle').textContent = book.title;

    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = `
      <p>تحميل الكتاب: <strong>${book.title}</strong></p>
      <p>اضغط على الرابط للقراءة وتحميل الكتاب:</p>
      <p><a href="${book.link}" target="_blank" rel="noopener">${book.link}</a></p>
      <div id="backToSearch">بحث جديد</div>
    `;

    document.title = `تحميل كتاب ${book.title}`;

    document.getElementById('backToSearch').addEventListener('click', () => {
      resetToSearch();
    });
  }

  function resetToSearch() {
    document.getElementById('message').textContent = '';
    document.getElementById('result').innerHTML = '';
    document.getElementById('searchForm').style.display = 'flex';
    document.getElementById('pageTitle').textContent = 'كوزو كتب';
    document.getElementById('searchInput').value = '';
    document.title = 'كوزو كتب';

    // إزالة query من الرابط URL
    history.replaceState(null, '', window.location.pathname);
  }

  async function searchAndShow(searchText) {
    try {
      if (!workbook) await loadExcel();

      const book = await findBookDetails(searchText);
      if (book) {
        showBookDetails(book);
        // تحديث الرابط بالباراميتر query
        history.replaceState(null, '', `?query=${encodeURIComponent(searchText)}`);
      } else {
        document.getElementById('message').textContent = `لم يتم العثور على كتاب مطابق لـ "${searchText}".`;
      }
    } catch (err) {
      document.getElementById('message').textContent = `حدث خطأ: ${err}`;
    }
  }

  document.getElementById('searchForm').addEventListener('submit', e => {
    e.preventDefault();
    const searchText = document.getElementById('searchInput').value.trim();
    if (searchText) {
      searchAndShow(searchText);
    }
  });

  window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const query = params.get('query');
    if (query) {
      document.getElementById('searchInput').value = query;
      searchAndShow(query);
    }
  };
</script>
</body>
</html>
